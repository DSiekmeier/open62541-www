

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Adding variables to a server &mdash; open62541 0.2.0-rc2 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="open62541 0.2.0-rc2 documentation" href="index.html"/>
        <link rel="up" title="Tutorials" href="tutorials.html"/>
        <link rel="next" title="Connecting a Variable with a Physical Process" href="tutorial_server_datasource.html"/>
        <link rel="prev" title="Building a simple server" href="tutorial_server_firststeps.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="toc.html" class="icon icon-home"> open62541
          

          
            
            <img src="_static/open62541_html.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                0.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="building.html">Building open62541</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="tutorial_datatypes.html">Working with Data Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_firststeps.html">Building a simple server</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Adding variables to a server</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#working-with-opc-ua-datatypes">Working with OPC UA Datatypes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#nodes-and-nodeids">Nodes and NodeIds</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_datasource.html">Connecting a Variable with a Physical Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_object.html">Working with Objects and Object types</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_method.html">Adding Methods to Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_client_firststeps.html">Building a simple client</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="protocol.html">Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="types.html">Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="information_modelling.html">Information Modelling</a></li>
<li class="toctree-l1"><a class="reference internal" href="services.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="server.html">Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="client.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="constants.html">Standard-Defined Constants</a></li>
<li class="toctree-l1"><a class="reference internal" href="namespace_compiler.html">XML Nodeset Compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="internal.html">Internals</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="toc.html">open62541</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="toc.html">Docs</a> &raquo;</li>
      
          <li><a href="tutorials.html">Tutorials</a> &raquo;</li>
      
    <li>Adding variables to a server</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/tutorial_server_variable.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="adding-variables-to-a-server">
<h1>Adding variables to a server<a class="headerlink" href="#adding-variables-to-a-server" title="Permalink to this headline">¶</a></h1>
<p>This tutorial shows how to work with data types and how to add variable nodes
to a server.</p>
<p>This is the code for a server with a single variable node holding an integer.
We will take this example to explain some of the fundamental concepts of
open62541.</p>
<div class="section" id="working-with-opc-ua-datatypes">
<h2>Working with OPC UA Datatypes<a class="headerlink" href="#working-with-opc-ua-datatypes" title="Permalink to this headline">¶</a></h2>
<p>The datatype <a class="reference internal" href="types.html#variant"><span class="std std-ref">Variant</span></a> belongs to the built-in datatypes of OPC UA and
is used as a container type. A variant can hold any other datatype as a
scalar (except variant) or as an array. Array variants can additionally
denote the dimensionality of the data (e.g. a 2x3 matrix) in an additional
integer array.</p>
<p>The <cite>UA_VariableAttributes</cite> type contains a variant member <cite>value</cite>. The
command <code class="docutils literal"><span class="pre">UA_Variant_setScalar(&amp;attr.value,</span> <span class="pre">&amp;myInteger,</span>
<span class="pre">&amp;UA_TYPES[UA_TYPES_INT32])</span></code> sets the variant to point to the integer. Note
that this does not make a copy of the integer (for which
<cite>UA_Variant_setScalarCopy</cite> can be used). The variant (and its content) is
then copied into the newly created node.</p>
<p>The above code could have used allocations by making copies of all entries of
the attribute variant. Then, of course, the variant content needs to be
deleted to prevent memleaks.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">UA_VariableAttributes</span> <span class="n">attr</span><span class="p">;</span>
<span class="n">UA_VariableAttributes_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
<span class="n">UA_Int32</span> <span class="n">myInteger</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
<span class="n">UA_Variant_setScalarCopy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">myInteger</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_INT32</span><span class="p">]);</span>
<span class="n">attr</span><span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">UA_LOCALIZEDTEXT_ALLOC</span><span class="p">(</span><span class="s">&quot;en_US&quot;</span><span class="p">,</span><span class="s">&quot;the answer&quot;</span><span class="p">);</span>
<span class="n">attr</span><span class="p">.</span><span class="n">displayName</span> <span class="o">=</span> <span class="n">UA_LOCALIZEDTEXT_ALLOC</span><span class="p">(</span><span class="s">&quot;en_US&quot;</span><span class="p">,</span><span class="s">&quot;the answer&quot;</span><span class="p">);</span>

<span class="n">UA_VariableAttributes_deleteMembers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
</pre></div>
</div>
<p>Finally, one needs to tell the server where to add the new variable in the
information model. For that, we state the NodeId of the parent node and the
(hierarchical) reference to the parent node.</p>
</div>
<div class="section" id="nodes-and-nodeids">
<h2>Nodes and NodeIds<a class="headerlink" href="#nodes-and-nodeids" title="Permalink to this headline">¶</a></h2>
<p>A <a class="reference internal" href="types.html#nodeid"><span class="std std-ref">NodeId</span></a> is a unique identifier in server&#8217;s context. It contains the
number of node&#8217;s namespace and either a numeric, string or GUID (Globally
Unique ID) identifier. The following are some examples for their usage.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">UA_NodeId</span> <span class="n">id1</span> <span class="o">=</span> <span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1234</span><span class="p">);</span>
<span class="n">UA_NodeId</span> <span class="n">id2</span> <span class="o">=</span> <span class="n">UA_NODEID_STRING</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;testid&quot;</span><span class="p">);</span>
<span class="n">UA_NodeId</span> <span class="n">id3</span> <span class="o">=</span> <span class="n">UA_NODEID_STRING_ALLOC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;testid&quot;</span><span class="p">);</span>
<span class="n">UA_NodeId_deleteMembers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id3</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;open62541.h&quot;</span><span class="cp"></span>

<span class="n">UA_Boolean</span> <span class="n">running</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stopHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">sign</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">UA_LOG_INFO</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span> <span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span> <span class="s">&quot;received ctrl-c&quot;</span><span class="p">);</span>
    <span class="n">running</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">signal</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">stopHandler</span><span class="p">);</span>
    <span class="n">signal</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">stopHandler</span><span class="p">);</span>

    <span class="n">UA_ServerConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="n">UA_ServerConfig_standard</span><span class="p">;</span>
    <span class="n">UA_ServerNetworkLayer</span> <span class="n">nl</span><span class="p">;</span>
    <span class="n">nl</span> <span class="o">=</span> <span class="n">UA_ServerNetworkLayerTCP</span><span class="p">(</span><span class="n">UA_ConnectionConfig_standard</span><span class="p">,</span> <span class="mi">16664</span><span class="p">);</span>
    <span class="n">config</span><span class="p">.</span><span class="n">networkLayers</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nl</span><span class="p">;</span>
    <span class="n">config</span><span class="p">.</span><span class="n">networkLayersSize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">UA_Server</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">UA_Server_new</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>

    <span class="cm">/* 1) Define the attribute of the myInteger variable node */</span>
    <span class="n">UA_VariableAttributes</span> <span class="n">attr</span><span class="p">;</span>
    <span class="n">UA_VariableAttributes_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
    <span class="n">UA_Int32</span> <span class="n">myInteger</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
    <span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">myInteger</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_INT32</span><span class="p">]);</span>
    <span class="n">attr</span><span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">UA_LOCALIZEDTEXT</span><span class="p">(</span><span class="s">&quot;en_US&quot;</span><span class="p">,</span><span class="s">&quot;the answer&quot;</span><span class="p">);</span>
    <span class="n">attr</span><span class="p">.</span><span class="n">displayName</span> <span class="o">=</span> <span class="n">UA_LOCALIZEDTEXT</span><span class="p">(</span><span class="s">&quot;en_US&quot;</span><span class="p">,</span><span class="s">&quot;the answer&quot;</span><span class="p">);</span>

    <span class="cm">/* 2) Add the variable node to the information model */</span>
    <span class="n">UA_NodeId</span> <span class="n">myIntegerNodeId</span> <span class="o">=</span> <span class="n">UA_NODEID_STRING</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;the.answer&quot;</span><span class="p">);</span>
    <span class="n">UA_QualifiedName</span> <span class="n">myIntegerName</span> <span class="o">=</span> <span class="n">UA_QUALIFIEDNAME</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;the answer&quot;</span><span class="p">);</span>
    <span class="n">UA_NodeId</span> <span class="n">parentNodeId</span> <span class="o">=</span> <span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UA_NS0ID_OBJECTSFOLDER</span><span class="p">);</span>
    <span class="n">UA_NodeId</span> <span class="n">parentReferenceNodeId</span> <span class="o">=</span> <span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UA_NS0ID_ORGANIZES</span><span class="p">);</span>
    <span class="n">UA_Server_addVariableNode</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">myIntegerNodeId</span><span class="p">,</span> <span class="n">parentNodeId</span><span class="p">,</span>
                              <span class="n">parentReferenceNodeId</span><span class="p">,</span> <span class="n">myIntegerName</span><span class="p">,</span>
                              <span class="n">UA_NODEID_NULL</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="cm">/* 3) Write another value */</span>
    <span class="n">myInteger</span> <span class="o">=</span> <span class="mi">43</span><span class="p">;</span>
    <span class="n">UA_Variant</span> <span class="n">myVar</span><span class="p">;</span>
    <span class="n">UA_Variant_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myVar</span><span class="p">);</span>
    <span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myVar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">myInteger</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_INT32</span><span class="p">]);</span>
    <span class="n">UA_Server_writeValue</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">myIntegerNodeId</span><span class="p">,</span> <span class="n">myVar</span><span class="p">);</span>

    <span class="cm">/* 4) Set the status code of the value */</span>
    <span class="n">UA_WriteValue</span> <span class="n">wv</span><span class="p">;</span>
    <span class="n">UA_WriteValue_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wv</span><span class="p">);</span>
    <span class="n">wv</span><span class="p">.</span><span class="n">nodeId</span> <span class="o">=</span> <span class="n">myIntegerNodeId</span><span class="p">;</span>
    <span class="n">wv</span><span class="p">.</span><span class="n">attributeId</span> <span class="o">=</span> <span class="n">UA_ATTRIBUTEID_VALUE</span><span class="p">;</span>
    <span class="n">wv</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">UA_STATUSCODE_BADNOTCONNECTED</span><span class="p">;</span>
    <span class="n">wv</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">hasStatus</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">UA_Server_write</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wv</span><span class="p">);</span>

    <span class="cm">/* 5) Reset to a good statuscode with a value */</span>
    <span class="n">wv</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">hasStatus</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">wv</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">myVar</span><span class="p">;</span>
    <span class="n">wv</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">hasValue</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">UA_Server_write</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wv</span><span class="p">);</span>

    <span class="n">UA_StatusCode</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">UA_Server_run</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">running</span><span class="p">);</span>
    <span class="n">UA_Server_delete</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
    <span class="n">nl</span><span class="p">.</span><span class="n">deleteMembers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nl</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tutorial_server_datasource.html" class="btn btn-neutral float-right" title="Connecting a Variable with a Physical Process" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tutorial_server_firststeps.html" class="btn btn-neutral" title="Building a simple server" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, The open62541 authors.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.2.0-rc2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>